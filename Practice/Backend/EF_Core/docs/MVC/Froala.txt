Cloudinary

 - Cloudinary is a rich text editor, with abilities also to upload images to our
   web application.

 Installation and configuration
  First, We need to create an account on onsole.cloudinary.com, where we can get 
  a CloudName, ApiKey, and an ApiSecret.

   "Cloudinary": {
   "CloudName": "dhladzjsy",
   "ApiKey": "344597186897974",
   "ApiSecret": "FBixlOqoFs-K_xrG008ieFW5apA"
   }

  1- From NuGet, download and install Cloudinarydotnet the latest version.
  2- Create a new interface and class under Repository, to be serving as 
     a service layer.

    IImageRepository.cs
     namespace Bloggie.Repositories
    {
        public interface IImageRepository
        {
            Task<string> UploadAsync(IFormFile file);  // string 
        }
    }


    CloudinaryImageRepository.cs

    using CloudinaryDotNet;
    using CloudinaryDotNet.Actions;

    namespace Bloggie.Repositories
    {
        public class CloudinaryImageRepository : IImageRepository
        {
            #region Fields
            private readonly IConfiguration _configuration;
            // Account class is from CloudinaryDotNet
            private readonly Account _account;
            #endregion

            #region Constructor
            public CloudinaryImageRepository(IConfiguration configuration)
            {
                _configuration = configuration;
                _account = new Account(
                    _configuration.GetSection("Cloudinary")["CloudName"],
                    _configuration.GetSection("CLoudinary")["ApiKey"],
                    _configuration.GetSection("Cloudinary")["ApiSecret"]
                    );
            }
            #endregion

            #region Methods
            public async Task<string> UploadAsync(IFormFile file)
            {
                // Create a new account
                var client = new Cloudinary(_account);

                // Upload an image 
                //=================
                var uploadParams = new ImageUploadParams()   // from CloudinaryDotNet.Actions;
                {
                    File = new FileDescription(file.FileName, file.OpenReadStream()),
                    DisplayName = file.FileName
                };
                var uploadResult = await client.UploadAsync(uploadParams);

                if (uploadResult != null &&
                    uploadResult.StatusCode == System.Net.HttpStatusCode.OK)
                {
                    return uploadResult.SecureUrl.ToString();
                }
                return null;
            }
            #endregion
        }
    }

  3- Inject both the Repository interface and the class in Program.cs
    app.Services.AddScope<IImageRepository, CloudinaryImageRepository>

  4- Create ImagesController.cs

    using Bloggie.Repositories;
    using Microsoft.AspNetCore.Http;
    using Microsoft.AspNetCore.Mvc;
    using System.Net;

    namespace Bloggie.Controllers
    {
        [Route("api/[controller]")]
        [ApiController]
        public class ImagesController : ControllerBase
        {

            #region Fields
            private readonly IImageRepository _imageRepository;
            #endregion

            #region Constructors
            public ImagesController(IImageRepository imageRepository)
            {
                _imageRepository = imageRepository;
            }
            #endregion

            #region Action Methods
            public async Task<IActionResult> UploadAsync(IFormFile file)
            // This method lets us upload an image into the cloud, using Fraola
            {
                // call a repository
                var imageUrl = await _imageRepository.UploadAsync(file);

                // If image upload did not work
                if (imageUrl == null)
                {
                    return Problem(
                        "Something went wrong!",
                        null,
                        (int)HttpStatusCode.InternalServerError);
                }
                return new JsonResult(new { link = imageUrl });
            }
            #endregion
        }
    }
 
 5- Update your Add and Update views with the required Cloudinary code and 
    JS scripts.

    Script needed in both views:
    @section Scripts {
        <script>
            var editor = new FroalaEditor("#content",
                {
                    // Upload the image file through ImagesController
                    imageUploadUrl: "/api/images"  // Upload the images using this controller instead
                });
        
            // Image upload 
            const featuredUploadElement = document.getElementById("featuredImageUpload");
            // Featured image url
            const featuredImageUrlElement = document.getElementById("featuredImgUrl");
            // Featured image display featuredImageDisplay
            const featuredImageElement = document.getElementById("featuredImageDisplay");


            async function uploadFeatureImage(e) {
                console.log(e.target.files[0]);
            let data = new FormData();
            data.append("file", e.target.files[0]);

            await fetch("/api/images", {
                method: "POST",
                headers: {
                    "Accept": "*/*",
                },
                body: data
            })
                .then(response => response.json())
                .then(result => {                
                    // Paste image url (result) in Featured Image URL field
                    featuredImageUrlElement.value = result.link;  // image link url
                    featuredImageElement.src = result.link;  // display image
                    featuredImageElement.style.display = "block";
                });
            }


            featuredUploadElement.addEventListener("change", uploadFeatureImage);
        </script>
    }

    Make sure you have these 3 new elements inside the form element:
      <div class="mb-3">
      <label class="form-label" for="featuredImageUpload">Featured Image Upload</label>
      <input id="featuredImageUpload" class="form-control" type="file"/>

      <img 
           src="" alt="Blog image" 
           id="featuredImageDisplay" 
           style="display:none; width: 150px;"
           />
      </div>

      <div class="mb-3">
          <label class="form-label" asp-for="FeaturedImgUrl">Featured Image URL</label>
          <input id="featuredImgUrl" class="form-control" type="text" asp-for="FeaturedImgUrl"/>
      </div>

    Pay attention to the ids for each element, they must match the ones used inside the 
    JS script at the bottom.

  6- Finally, add the CDN link provided from Cloudinary.com into file 
     _Layout.cshtml inside the <head> element, and not in the <body>
     

